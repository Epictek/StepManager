@page "/songs"

@using AngleSharp;
@using System.IO.Compression;
@using System.IO
@using System.Net.Http
@using AngleSharp.Dom
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using Microsoft.Extensions.Logging.Abstractions
@using System.Collections.Concurrent
@using System.Diagnostics
@using Microsoft.JSInterop
@using StepmaniaUtils
@inject ILogger<Main> Logger
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudThemeProvider IsDarkMode="true" />
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudGrid>
    <MudItem xs="12">
        <MudPaper Height="100%" Width="100%">
            @* <MudImage Style="margin-left: auto;margin-right: auto;display: block;" Src="@Banner" Elevation="25" Class="rounded-lg"/> *@
            <MudTable
                Height="900px"
                Hover="true"
                FixedHeader="true"
                Dense="true"
                Items="@Songs"
                GroupBy="@_groupDefinition"
                MultiSelection="true"
                Loading="@Loading">
                <ColGroup>
                    <col style="width: 20px;" />
                    <col style="width: 128px;"/>
                    <col/>
                    <col/>
                    <col/>
                    <col style="width: 60px;"/>
                </ColGroup>
                <HeaderContent>
                    <MudTh>Banner</MudTh>
                    <MudTh><MudTableSortLabel  SortBy="new Func<SmFile, object>(x => x.Artist)">Artist</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<SmFile, object>(x => x.SongTitle)">Title</MudTableSortLabel></MudTh>
                    <MudTh>Difficulty</MudTh>
                    <MudTh>BPM</MudTh>
                </HeaderContent>
                <GroupHeaderTemplate>
                    <MudTh Class="mud-table-cell-custom-group" colspan="5">
                        @{
                            var banner = GetPackImage((string)context.Key);
                            if (banner != null)
                            {
                                <MudImage Height="80" Src="@Base64Image(banner)"></MudImage>
                            }
                            @context.Key
                        }
                    </MudTh>
                </GroupHeaderTemplate>
                <RowTemplate>
                    <MudTd DataLabel="Banner"><MudImage Height="40" Src="@(Base64Image(Path.Combine(context.Directory, context.BannerPath)))"/></MudTd>
                    <MudTd DataLabel="Artist">@context.Artist</MudTd>
                    <MudTd DataLabel="Title">@context.SongTitle</MudTd>
                    <MudTd DataLabel="Difficulty">@string.Join(',', context.ChartMetadata.StepCharts.Select(x=> x.Difficulty).Distinct())</MudTd>
                    <MudTd DataLabel="BPM">@context.DisplayBpm</MudTd>
                    <MudTd DataLabel="Actions">
                         <MudToggleIconButton Toggled="@context.Equals(_currentPlaying)"
                                             ToggledChanged="(t) => OnAudioToggle(t, context)"
                                             Icon="@Icons.Material.Filled.PlayCircle" Color="@Color.Success" Title="Play"
                                             ToggledIcon="@Icons.Material.Filled.StopCircle" ToggledColor="@Color.Error" ToggledTitle="Stop"/>
                                    
                    </MudTd>

                </RowTemplate>
                            
            </MudTable>
        </MudPaper>
    </MudItem>
    }
</MudGrid>

<audio src="@_currentFile" autoplay></audio>

@code {
    SmFile _currentPlaying;

    string _currentFile;

    string Base64Image(string imageFilepath)
    {
        return "data:image/png;base64," + Convert.ToBase64String(File.ReadAllBytes(imageFilepath));
        
    }
    
    string Base64Audio(string imageFilepath)
    {
        return "data:audio/ogg;base64," + Convert.ToBase64String(File.ReadAllBytes(imageFilepath));
        
    }

    string GetPackDir(string pack)
    {
        return Path.Combine(@"C:\Games\Project OutFox\Songs\", pack);
    }

    string? GetPackImage(string pack)
    {
        var bannerPath = Path.Combine(GetPackDir(pack), "banner.png");
        if (File.Exists(bannerPath))
        {
            return bannerPath;
        }
        return Directory.GetFiles(GetPackDir(pack), "*.png").FirstOrDefault() 
               ?? Directory.GetFiles(GetPackDir(pack), "*.jpg").FirstOrDefault();
    }
    
    
    private bool Loading = true;
    private IEnumerable<SmFile> Songs = new List<SmFile>();
    // private IEnumerable<IGrouping<string, SongMetadata>> FilteredSongs = new List<IGrouping<string, SongMetadata>>();

    string SelectedPack;
    
    string Title;
    string Banner;

    // private string searchTextValue;

    // string SearchTextValue
    // {
    //     get => searchTextValue;
    //     set
    //     {
    //         searchTextValue = value;
    //         SearchTextChanged();
    //     }
    // }

    IBrowsingContext context;

    protected override async Task OnInitializedAsync()
    {
        IProgress<string> progress = new Progress<string>(s => _ = JSRuntime.InvokeVoidAsync("console.log", s));
        Loading = true;
        Songs = await ScanSongDataAsync(@"C:\Games\Project OutFox\", progress);
        Loading = false;
    // FilteredSongs = Songs;
    }
    

            public async Task<List<SmFile>> ScanSongDataAsync(string stepmaniaRootPath, IProgress<string> progress)
        {
            var fileQueue = new BlockingCollection<string>();
            var result = new ConcurrentBag<SmFile>();

            Logger.LogInformation($"{nameof(ScanSongDataAsync)} - Scanning Song Library");
            progress.Report("Scanning Song Library: 0");

            var stopwatch = new Stopwatch();
            stopwatch.Start();

            var producer = Task.Run(() =>
            {
                var songsPath = Path.Combine(stepmaniaRootPath, @"Songs");
                foreach (var file in Directory.EnumerateFiles(songsPath, "*.sm", SearchOption.AllDirectories).AsParallel())
                {
                    fileQueue.Add(file);
                }

                fileQueue.CompleteAdding();
            });

            Logger.LogInformation($"{nameof(ScanSongDataAsync)} - Creating consumer queue, workers: {Environment.ProcessorCount}");


            var consumers = Enumerable.Range(0, Environment.ProcessorCount * 2)
                .Select(_ => Task.Run(() =>
                {
                    foreach (string file in fileQueue.GetConsumingEnumerable())
                    {
                        try
                        {
                            var song = new SmFile(file);
                            result.Add(song);
                            
                            progress.Report($"Scanning Song Library: {result.Count}");
                        }
                        catch (Exception e)
                        {
                         JSRuntime.InvokeVoidAsync("console.log",$"{nameof(ScanSongDataAsync)} - Could not load file at: {file}\n{e}");
                        }
                    }
                }));
            
            await Task.WhenAll(consumers);
            
            stopwatch.Stop();

            _ = JSRuntime.InvokeVoidAsync("console.log",($"{nameof(ScanSongDataAsync)} - Songs Loaded: {result.Count}, Time Elapsed: {stopwatch.ElapsedMilliseconds} ms"));
            return result.ToList();
        }
    

    private TableGroupDefinition<SmFile> _groupDefinition = new TableGroupDefinition<SmFile>()
    {
        GroupName = "Group",
        Indentation = true,
        Expandable = true,
        Selector = (e) => e.Group,
    };
    
    // private void SearchTextChanged()
    // {
    //     if (string.IsNullOrEmpty(SearchTextValue))
    //     {
    //         FilteredSongs = Songs;
    //     }
    //     else
    //     {
    //         FilteredSongs = Songs.Where(x => x.Key.Contains(SearchTextValue));
    //     }
    // }

    private void OnAudioToggle(bool toggle, SmFile file)
    {
        if (toggle)
        {
            _currentPlaying = file;
            _currentFile = Base64Audio(Directory.GetFiles(file.Directory, "*.ogg").FirstOrDefault());
        }
        else
        {
            _currentPlaying = null;

            _currentFile = "";
        }
    }

}